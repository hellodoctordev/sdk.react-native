var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=HDVideoCallView;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _lodash=_interopRequireDefault(require("lodash"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _MaterialCommunityIcons=_interopRequireDefault(require("react-native-vector-icons/MaterialCommunityIcons"));var activeCallManager=_interopRequireWildcard(require("../../telecom/activeCallManager"));var connectionManager=_interopRequireWildcard(require("../../telecom/connectionManager"));var _HDVideoCallActions=_interopRequireDefault(require("./HDVideoCallActions"));var _native=require("./native");var _jsxFileName="/Users/hellodoctor/workspace/mobile/sdk/react-native/lib/ui/video/HDVideoCallView.js";function _getRequireWildcardCache(nodeInterop){if(typeof WeakMap!=="function")return null;var cacheBabelInterop=new WeakMap();var cacheNodeInterop=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop;})(nodeInterop);}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj;}if(obj===null||typeof obj!=="object"&&typeof obj!=="function"){return{default:obj};}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj);}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(key!=="default"&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}newObj.default=obj;if(cache){cache.set(obj,newObj);}return newObj;}function HDVideoCallView(props){var _this=this;var consultationID=props.consultationID,videoRoomSID=props.videoRoomSID,accessToken=props.accessToken;var _useState=(0,_react.useState)(),_useState2=(0,_slicedToArray2.default)(_useState,2),remoteParticipantSID=_useState2[0],setRemoteParticipantSID=_useState2[1];var _useState3=(0,_react.useState)(),_useState4=(0,_slicedToArray2.default)(_useState3,2),remoteVideoState=_useState4[0],setRemoteVideoState=_useState4[1];var _useState5=(0,_react.useState)(),_useState6=(0,_slicedToArray2.default)(_useState5,2),remoteAudioState=_useState6[0],setRemoteAudioState=_useState6[1];var accessTokenRef=(0,_react.useRef)('');var participantsRef=(0,_react.useRef)([]);var _Dimensions$get=_reactNative.Dimensions.get('screen'),screenHeight=_Dimensions$get.height,screenWidth=_Dimensions$get.width;var localVideoWidthRef=(0,_react.useRef)(new _reactNative.Animated.Value(screenWidth));var localVideoHeightRef=(0,_react.useRef)(new _reactNative.Animated.Value(screenHeight));var localVideoBottomRef=(0,_react.useRef)(new _reactNative.Animated.Value(0));var localVideoLeftRef=(0,_react.useRef)(new _reactNative.Animated.Value(0));var aspectRatio=1.4;var insetVideoHeight=screenHeight/4;var insetVideoWidth=insetVideoHeight/aspectRatio;var doMinimizeLocalVideoView=function doMinimizeLocalVideoView(){return _reactNative.Animated.parallel([_reactNative.Animated.timing(localVideoHeightRef.current,{toValue:insetVideoHeight,useNativeDriver:false}),_reactNative.Animated.timing(localVideoWidthRef.current,{toValue:insetVideoWidth,useNativeDriver:false}),_reactNative.Animated.timing(localVideoBottomRef.current,{toValue:12,useNativeDriver:false}),_reactNative.Animated.timing(localVideoLeftRef.current,{toValue:12,useNativeDriver:false})]).start();};var doMaximizeLocalVideoView=function doMaximizeLocalVideoView(){return _reactNative.Animated.parallel([_reactNative.Animated.timing(localVideoHeightRef.current,{toValue:screenHeight,useNativeDriver:false}),_reactNative.Animated.timing(localVideoWidthRef.current,{toValue:screenWidth,useNativeDriver:false}),_reactNative.Animated.timing(localVideoBottomRef.current,{toValue:0,useNativeDriver:false}),_reactNative.Animated.timing(localVideoLeftRef.current,{toValue:0,useNativeDriver:false})]).start();};var RemoteParticipantStateOverlay=function RemoteParticipantStateOverlay(){var videoStateOpacity=remoteVideoState==='disabled'?1:0;var audioStateOpacity=remoteAudioState==='disabled'?1:0;return _react.default.createElement(_reactNative.View,{style:{position:'absolute',height:screenHeight,width:screenWidth,backgroundColor:'transparent'},__self:_this,__source:{fileName:_jsxFileName,lineNumber:51,columnNumber:13}},_react.default.createElement(_reactNative.View,{style:{flex:1,justifyContent:'center',alignItems:'center',opacity:videoStateOpacity},__self:_this,__source:{fileName:_jsxFileName,lineNumber:52,columnNumber:17}},_react.default.createElement(_MaterialCommunityIcons.default,{name:'video-off',size:48,color:'white',solid:true,__self:_this,__source:{fileName:_jsxFileName,lineNumber:53,columnNumber:21}}),_react.default.createElement(_reactNative.Text,{style:{fontSize:24,color:'white',marginTop:24},__self:_this,__source:{fileName:_jsxFileName,lineNumber:54,columnNumber:21}},"Video en pausa")),_react.default.createElement(_reactNative.View,{style:{position:'absolute',bottom:84,right:12,opacity:audioStateOpacity},__self:_this,__source:{fileName:_jsxFileName,lineNumber:58,columnNumber:17}},_react.default.createElement(_MaterialCommunityIcons.default,{name:'microphone-off',color:'#C52723',size:32,__self:_this,__source:{fileName:_jsxFileName,lineNumber:59,columnNumber:21}})));};var didRenderRemoteParticipantRef=(0,_react.useRef)(false);var renderAttemptsRef=(0,_react.useRef)(0);var remoteParticipantRenderCheckTimeoutRef=(0,_react.useRef)(0);var doSetRemoteParticipantSID=function doSetRemoteParticipantSID(remoteParticipantSID){didRenderRemoteParticipantRef.current=false;setRemoteParticipantSID(remoteParticipantSID);clearTimeout(remoteParticipantRenderCheckTimeoutRef.current);remoteParticipantRenderCheckTimeoutRef.current=setTimeout(function(){if(_reactNative.Platform.OS!=='ios'){return;}if(!didRenderRemoteParticipantRef.current&&renderAttemptsRef.current<10){console.info('[HDVideoCallView:doSetRemoteParticipantSID:RETRYING]',renderAttemptsRef.current);renderAttemptsRef.current=renderAttemptsRef.current+1;setRemoteParticipantSID();setTimeout(function(){return doSetRemoteParticipantSID(remoteParticipantSID);},500);}},1000);};var handleConnectedToRoomEvent=function handleConnectedToRoomEvent(event){console.info('[handleConnectedToRoomEvent]',event);var participants=event.participants;participantsRef.current=participants;var remoteParticipantIdentity=_lodash.default.first(participants);if(remoteParticipantIdentity){doMinimizeLocalVideoView();doSetRemoteParticipantSID(remoteParticipantIdentity);}};var handleParticipantDisconnectedEvent=function handleParticipantDisconnectedEvent(participantIdentity){console.info("[handleParticipantDisconnectedEvent:"+participantIdentity+"]",participantsRef.current);participantsRef.current=participantsRef.current.filter(function(p){return p!==participantIdentity;});var remoteParticipantIdentity=_lodash.default.first(participantsRef.current);if(remoteParticipantIdentity){doMinimizeLocalVideoView();doSetRemoteParticipantSID(remoteParticipantIdentity);}else{doMaximizeLocalVideoView();}};var handleParticipantRoomConnectionEvent=function handleParticipantRoomConnectionEvent(event){console.info('[handleParticipantRoomConnectionEvent]',event);var action=event.action,participantIdentity=event.participantIdentity;switch(action){case'disconnected':handleParticipantDisconnectedEvent(participantIdentity);break;}};var handleParticipantVideoEvent=function handleParticipantVideoEvent(event){console.info('[handleParticipantVideoEvent]',event);var participantIdentity=event.participantIdentity;var handleParticipantConnectedEvent=function handleParticipantConnectedEvent(){participantsRef.current=_lodash.default.uniq([].concat((0,_toConsumableArray2.default)(participantsRef.current),[participantIdentity]));doSetRemoteParticipantSID(participantIdentity);doMinimizeLocalVideoView();};switch(event.action){case'connected':case'published':case'subscribed':handleParticipantConnectedEvent();break;case'disconnected':case'unpublished':case'unsubscribed':handleParticipantDisconnectedEvent(participantIdentity);break;case'disabledVideo':setRemoteVideoState('disabled');break;case'enabledVideo':setRemoteVideoState('enabled');break;case'renderedParticipant':didRenderRemoteParticipantRef.current=true;break;}};var handleParticipantAudioEvent=function handleParticipantAudioEvent(event){console.info('[handleParticipantAudioEvent]',event);switch(event.action){case'disabledAudio':setRemoteAudioState('disabled');break;default:setRemoteAudioState('enabled');break;}};(0,_react.useEffect)(function(){console.info('[VideoCallModal:MOUNT]',{videoRoomSID:videoRoomSID});var connectedToRoomListener=_native.hdEventEmitter.addListener('connectedToRoom',handleConnectedToRoomEvent);var participantRoomConnectionEventListener=_native.hdEventEmitter.addListener('participantRoomConnectionEvent',handleParticipantRoomConnectionEvent);var participantVideoEventListener=_native.hdEventEmitter.addListener('participantVideoEvent',handleParticipantVideoEvent);var participantAudioEventListener=_native.hdEventEmitter.addListener('participantAudioEvent',handleParticipantAudioEvent);connectionManager.handleIncomingVideoCallStarted(videoRoomSID);return function(){console.info('[VideoCallModal] removed connectedToRoomListener');connectedToRoomListener.remove();participantRoomConnectionEventListener.remove();participantVideoEventListener.remove();participantAudioEventListener.remove();clearTimeout(remoteParticipantRenderCheckTimeoutRef.current);activeCallManager.disconnect().catch(function(error){return console.warn("error disconnecting from video room "+videoRoomSID+": "+JSON.stringify(error));});};},[]);var tryConnect=function tryConnect(){console.info('[HDVideoCallRenderer:tryConnect]');if(!accessToken){console.info("can't connect video call: no access token available yet");return;}accessTokenRef.current=accessToken;activeCallManager.connect(videoRoomSID,accessToken).catch(function(error){return console.warn("error connecting to video room "+videoRoomSID+": "+JSON.stringify(error));});};(0,_react.useEffect)(function(){if(accessToken){tryConnect();}},[accessToken]);var videoCallStatus=!remoteParticipantSID?'waiting':'in-progress';var handleOnEndCall=function(){var _ref=(0,_asyncToGenerator2.default)(function*(){if(props.onEndCall){props.onEndCall(consultationID,videoRoomSID);}yield connectionManager.endVideoCall(videoRoomSID);});return function handleOnEndCall(){return _ref.apply(this,arguments);};}();return _react.default.createElement(_reactNative.View,{style:{flex:1},__self:this,__source:{fileName:_jsxFileName,lineNumber:258,columnNumber:9}},_react.default.createElement(_reactNative.View,{style:{flex:1,backgroundColor:'black'},__self:this,__source:{fileName:_jsxFileName,lineNumber:259,columnNumber:13}},_react.default.createElement(_reactNative.View,{__self:this,__source:{fileName:_jsxFileName,lineNumber:260,columnNumber:17}},_react.default.createElement(_native.RemoteVideoView,{participantSID:remoteParticipantSID,style:{height:'100%',width:'100%'},__self:this,__source:{fileName:_jsxFileName,lineNumber:261,columnNumber:21}}),_react.default.createElement(RemoteParticipantStateOverlay,{__self:this,__source:{fileName:_jsxFileName,lineNumber:262,columnNumber:21}})),_react.default.createElement(_reactNative.Animated.View,{style:{position:'absolute',width:localVideoWidthRef.current,height:localVideoHeightRef.current,bottom:localVideoBottomRef.current,left:localVideoLeftRef.current,borderRadius:2,backgroundColor:'#000000',shadowOffset:{height:1,width:1},shadowColor:'black',shadowRadius:3,shadowOpacity:0.5,padding:2},__self:this,__source:{fileName:_jsxFileName,lineNumber:264,columnNumber:17}},_react.default.createElement(_native.LocalVideoView,{style:{width:'100%',height:'100%'},__self:this,__source:{fileName:_jsxFileName,lineNumber:277,columnNumber:21}}))),_react.default.createElement(_reactNative.View,{style:{position:'absolute',height:screenHeight,width:screenWidth},__self:this,__source:{fileName:_jsxFileName,lineNumber:280,columnNumber:13}},_react.default.createElement(_HDVideoCallActions.default,{onEndCall:handleOnEndCall,videoRoomSID:videoRoomSID,videoCallStatus:videoCallStatus,__self:this,__source:{fileName:_jsxFileName,lineNumber:281,columnNumber:17}})));}