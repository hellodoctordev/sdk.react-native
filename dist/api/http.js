var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.nullSafeJsonResponse=exports.HelloDoctorHTTPClient=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _currentUser=require("../users/currentUser");var _HDConfig=_interopRequireDefault(require("../HDConfig"));var HelloDoctorHTTPClient=function(){function HelloDoctorHTTPClient(){(0,_classCallCheck2.default)(this,HelloDoctorHTTPClient);}(0,_createClass2.default)(HelloDoctorHTTPClient,[{key:"get",value:function(){var _get=(0,_asyncToGenerator2.default)(function*(path){return this.doRequest(path,'GET');});function get(_x){return _get.apply(this,arguments);}return get;}()},{key:"post",value:function(){var _post=(0,_asyncToGenerator2.default)(function*(path,data){return this.doRequest(path,'POST',data);});function post(_x2,_x3){return _post.apply(this,arguments);}return post;}()},{key:"put",value:function(){var _put=(0,_asyncToGenerator2.default)(function*(path,data){return this.doRequest(path,'PUT',data);});function put(_x4,_x5){return _put.apply(this,arguments);}return put;}()},{key:"delete",value:function(){var _delete2=(0,_asyncToGenerator2.default)(function*(path){return this.doRequest(path,'DELETE');});function _delete(_x6){return _delete2.apply(this,arguments);}return _delete;}()},{key:"doRequest",value:function(){var _doRequest=(0,_asyncToGenerator2.default)(function*(path,method,data){var _this=this;var url=""+_HDConfig.default.serviceHost+path;var doFetch=function doFetch(){return fetch(url,{method:method,body:JSON.stringify(data),headers:_this.getRequestHeaders()});};var response=yield doFetch();if(response.status===401){yield this.refreshAccessToken();response=yield doFetch();}return nullSafeJsonResponse(response);});function doRequest(_x7,_x8,_x9){return _doRequest.apply(this,arguments);}return doRequest;}()},{key:"getRequestHeaders",value:function getRequestHeaders(){var currentUser=(0,_currentUser.getCurrentUser)();var requestHeaders={"Content-Type":"application/json"};if(currentUser!==null){requestHeaders["Authorization"]="Bearer "+currentUser.jwt;requestHeaders["X-User-UID"]=currentUser.uid;}if(!!HelloDoctorHTTPClient.API_KEY){requestHeaders["X-Api-Key"]=HelloDoctorHTTPClient.API_KEY;}return requestHeaders;}},{key:"refreshAccessToken",value:function(){var _refreshAccessToken=(0,_asyncToGenerator2.default)(function*(){var currentUser=(0,_currentUser.getCurrentUser)();if(!(currentUser!=null&&currentUser.refreshToken)){return;}if((currentUser==null?void 0:currentUser.uid)===null&&!currentUser.refreshToken){throw new Error('[refreshAccessToken] cannot refresh access token: no user and/or refresh token available');}else if(!(currentUser!=null&&currentUser.refreshToken)){return;}var authenticationResponse=yield this.post("/users/"+currentUser.uid+"/_authenticate",{refreshToken:currentUser.refreshToken});currentUser.jwt=authenticationResponse.jwt;currentUser.refreshToken=authenticationResponse.refreshToken;});function refreshAccessToken(){return _refreshAccessToken.apply(this,arguments);}return refreshAccessToken;}()}]);return HelloDoctorHTTPClient;}();exports.HelloDoctorHTTPClient=HelloDoctorHTTPClient;HelloDoctorHTTPClient.API_KEY="";var nullSafeJsonResponse=function nullSafeJsonResponse(response){if(response.status<200||response.status>=300){console.warn("[Http.nullSafeJsonResponse:BAD_STATUS:"+response.status+"]",response);throw new Error(response.statusText);}return response.json();};exports.nullSafeJsonResponse=nullSafeJsonResponse;